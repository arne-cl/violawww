# –ö–æ–¥-—Ä–µ–≤—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –±–∞–≥–æ–≤: –ê–Ω–∞–ª–∏–∑ –≥–ª—É–±–∏–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

–í—Å–µ —Ç—Ä–∏ —Ñ–∏–∫—Å–∞ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç **—Ä–µ–∞–ª—å–Ω—ã–µ –±–∞–≥–∏**, –Ω–æ –Ω–µ –≤—Å–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≥–ª—É–±–æ–∫–æ –∫–æ–ø–∞—é—Ç –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–±–ª–µ–º—ã.

---

## –§–∏–∫—Å 1: heap-use-after-free –≤ styleAttr (html2.c)

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- –°—Ç—Ä–æ–∫–∞ —Ç–µ–ø–µ—Ä—å **–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è** –≤–º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ –ø–∞–º—è—Ç—å SGML –ø–∞—Ä—Å–µ—Ä–∞
- –î–æ–±–∞–≤–ª–µ–Ω `free()` –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –≤ `CB_HTML_etag`

### –ê–Ω–∞–ª–∏–∑ –≥–ª—É–±–∏–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

‚úÖ **–•–æ—Ä–æ—à–æ**: –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã - –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≤–ª–∞–¥–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é.
- –ü—Ä–æ–±–ª–µ–º–∞: `value[i]` –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –≤ SGML.c:119 (`handle_attribute_name`)
- –†–µ—à–µ–Ω–∏–µ: –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É, –ø–æ–ª—É—á–∞–µ–º –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ

‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: 
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `if (strlen(line) == MAX_SIZE - 1)` –≤ xbitmap.c:160 –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–µ–∑–∞–Ω–∞
- –ù–æ –Ω–∞—à —Ñ–∏–∫—Å –≤ zgets —Ç–µ–ø–µ—Ä—å –æ–±—Ä–µ–∑–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ - —ç—Ç–æ **–∏–∑–º–µ–Ω—è–µ—Ç —Å–µ–º–∞–Ω—Ç–∏–∫—É**
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –ª–æ–º–∞–µ—Ç –ª–∏ —ç—Ç–æ –ª–æ–≥–∏–∫—É –ø–∞—Ä—Å–µ—Ä–∞ XBM

‚ùå **–ù–µ–ø–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤ zgets**:
```c
if (p >= size - 1) {
    buf[size - 1] = '\0';  // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∞–π—Ç!
    return ((char*)buf);
}
```
- –ú—ã **—Ç–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª** –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
- –ù—É–∂–Ω–æ –ª–∏–±–æ —á–∏—Ç–∞—Ç—å —Å–∏–º–≤–æ–ª, –ø—Ä–æ–≤–µ—Ä—è—Ç—å –µ–≥–æ, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –æ–±—Ä–µ–∑–∞—Ç—å, –ª–∏–±–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. ‚úÖ –§–∏–∫—Å styleAttr - **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π**, –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã
2. ‚ö†Ô∏è –§–∏–∫—Å zgets - **—á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π**, –Ω–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±—Ä–µ–∑–∫–∏
3. üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ—Ç –ª–∏ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç, –≥–¥–µ `value[i]` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –§–∏–∫—Å 2: stack-buffer-overflow –≤ zgets (zio.c)

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- –ò–∑–º–µ–Ω–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å `if (p == size)` –Ω–∞ `if (p >= size - 1)`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é null-terminator

### –ê–Ω–∞–ª–∏–∑ –≥–ª—É–±–∏–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∏–∫–µ**:
```c
while (doRead(zf, buf + p, 1) > 0) {
    if (p >= size - 1) {  // –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –≤ buf[p]!
        buf[size - 1] = '\0';  // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ, —á—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∏
        return ((char*)buf);
    }
```

### –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã:
- –§—É–Ω–∫—Ü–∏—è —á–∏—Ç–∞–µ—Ç –±–∞–π—Ç **–ø–µ—Ä–µ–¥** –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥—Ä–∞–Ω–∏—Ü
- –ö–æ–≥–¥–∞ `p == size - 1`, –º—ã —á–∏—Ç–∞–µ–º –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞–ª–∏–¥–Ω—ã–π –±–∞–π—Ç, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ

### –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```c
char* zgets(byte* buf, unsigned int size, ZFILE* zf) {
    int p = 0;
    
    if (size < 2) return NULL;  // –ù—É–∂–Ω–æ –º–µ—Å—Ç–æ –¥–ª—è null-terminator
    
    while (p < size - 1 && doRead(zf, buf + p, 1) > 0) {
        if (buf[p] == '\n') {
            buf[p + 1] = '\0';
            return ((char*)buf);
        }
        p++;
    }
    
    // –ï—Å–ª–∏ –≤—ã—à–ª–∏ –∏–∑ —Ü–∏–∫–ª–∞ –∏–∑-–∑–∞ EOF, –Ω—É–∂–Ω–æ null-terminate
    if (p > 0 || p < size - 1) {
        buf[p] = '\0';
        return (p > 0 ? (char*)buf : NULL);
    }
    
    // –ë—É—Ñ–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω, –Ω–æ –Ω–µ –±—ã–ª–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
    buf[size - 1] = '\0';
    return ((char*)buf);
}
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü —Ç–µ–ø–µ—Ä—å –î–û —á—Ç–µ–Ω–∏—è (`p < size - 1`)
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞
3. ‚úÖ –õ–æ–≥–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è - –Ω–µ —Ç–µ—Ä—è–µ–º —Å–∏–º–≤–æ–ª—ã, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ

---

## –§–∏–∫—Å 3: negative array index –≤ encodeURL (html2.c)

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- –ö–∞—Å—Ç `*str` –≤ `unsigned char` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–∞–∫ –∏–Ω–¥–µ–∫—Å–∞ –º–∞—Å—Å–∏–≤–∞

### –ê–Ω–∞–ª–∏–∑ –≥–ª—É–±–∏–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

‚úÖ **–û—Ç–ª–∏—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –ø—Ä–∞–≤–∏—Ç –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã:
- –ü—Ä–æ–±–ª–µ–º–∞: `char` –º–æ–∂–µ—Ç –±—ã—Ç—å signed, –∑–Ω–∞—á–µ–Ω–∏—è >= 128 —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏
- –†–µ—à–µ–Ω–∏–µ: –Ø–≤–Ω—ã–π –∫–∞—Å—Ç –≤ `unsigned char` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω [0, 255]

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:
```c
while ((c = (unsigned char)*str++) && (encode = URLEncodeSeq[c])) {
```
–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ `\0`, —á—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ - —Ü–∏–∫–ª –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ null-terminator.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏ –≥–ª—É–±–æ–∫–æ–µ**
2. üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ—Ç –ª–∏ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç –≤ –∫–æ–¥–µ, –≥–¥–µ `char` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏–Ω–¥–µ–∫—Å –±–µ–∑ –∫–∞—Å—Ç–∞
3. üí° –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π assertion –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Ç–æ–º, –ø–æ—á–µ–º—É –Ω—É–∂–µ–Ω –∫–∞—Å—Ç

---

## –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

### 1. –ü—Ä–æ–±–ª–µ–º–∞ –≤–ª–∞–¥–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é
- `value[i]` –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –≤ SGML –ø–∞—Ä—Å–µ—Ä–µ, –Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ html2.c
- –ù—É–∂–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –∫—Ç–æ –≤–ª–∞–¥–µ–µ—Ç –ø–∞–º—è—Ç—å—é –≤ –∫–∞–∂–¥–æ–º —Å–ª—É—á–∞–µ
- –í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø–µ—Ä–µ–¥–∞—á–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤

### 2. –†–∞–∑–º–µ—Ä—ã –±—É—Ñ–µ—Ä–æ–≤
- `MAX_SIZE = 255` –≤ xbitmap.c, –Ω–æ –±—É—Ñ–µ—Ä `line[MAX_SIZE]` 
- –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç, –ø–∞—Ä—Å–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç NULL - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
- –ù–æ –Ω–∞—à —Ñ–∏–∫—Å –≤ zgets –∏–∑–º–µ–Ω—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ - —Ç–µ–ø–µ—Ä—å –æ–±—Ä–µ–∑–∞–µ—Ç –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏

### 3. –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –î—Ä—É–≥–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `sendMessage1N2str`, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–ø–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏
- `styleAttr` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –Ω–∞–ø—Ä—è–º—É—é - –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- –¢–µ–ø–µ—Ä—å –≤—Å—ë —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ

---

## –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:

| –§–∏–∫—Å | –ì–ª—É–±–∏–Ω–∞ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|------|---------|---------------|--------------|
| styleAttr | ‚úÖ –ì–ª—É–±–æ–∫–∏–π | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å |
| zgets | ‚úÖ –ì–ª—É–±–æ–∫–∏–π | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) |
| encodeURL | ‚úÖ –ì–ª—É–±–æ–∫–∏–π | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å |

### –ò—Ç–æ–≥–æ–≤—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:
1. ‚úÖ –í—Å–µ —Ç—Ä–∏ —Ñ–∏–∫—Å–∞ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç **–∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã**, –∞ –Ω–µ –º–∞—Å–∫–∏—Ä—É—é—Ç —Å–∏–º–ø—Ç–æ–º—ã
2. ‚úÖ **zgets** —É–ª—É—á—à–µ–Ω–∞ - —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –î–û —á—Ç–µ–Ω–∏—è, –Ω–µ —Ç–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
3. üîç **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** –¥–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è edge cases –≤—Å–µ—Ö —Ç—Ä–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
4. üí° **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ**: —Å—Ç–æ–∏—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –µ–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –≤–ª–∞–¥–µ–Ω–∏—é –ø–∞–º—è—Ç—å—é –¥–ª—è –≤—Å–µ—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤

